<?xml version="1.0" encoding="UTF-8"?>
<beans
    xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:util="http://www.springframework.org/schema/util"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
                        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.0.xsd"
>

	<bean id="messageSourceCache" class="com.elasticpath.commons.util.impl.MessageSourceCacheImpl" init-method="init">
		<property name="assetRepository" ref="assetRepository"/>
		<property name="failIfAssetsMissing" value="true"/>
		<property name="defaultLanguage" value="en"/>
	</bean>

	<!-- !!!! DOCvelocitySFxml -->
	<!-- message source to be used by velocity templates. -->
    <bean id="messageSource" class="com.elasticpath.commons.util.impl.StoreThemeMessageSource" >
		<property name="storeConfig" ref="threadLocalStorage"/>
		<property name="storeMessageSource" ref="storeMessageSourceDelegate"/>
		<!-- True if you want missing messages to show up as just the key used to look for them. e.g. user.firstname.
			 False will allow exception to be thrown, and stop template render. -->
       <property name="useCodeAsDefaultMessage">
            <value>true</value>
        </property>
    </bean>
	<bean id="storeMessageSourceDelegate" class="com.elasticpath.commons.util.impl.StoreMessageSourceImpl">
		<property name="messageSourceCache">
            <ref bean="messageSourceCache"/>
        </property>
		<property name="globalMessageSource">
            <ref bean="globalMessageSource"/>
        </property>
        <property name="settingsReader" ref="settingsReader"/>
	</bean>


	<bean id="globalMessageSource" class="org.springframework.context.support.ReloadableResourceBundleMessageSource">
	    <property name="basenames">
	        <list>
	            <value>org.springframework.security/messages</value>
	        </list>
	    </property>
        <!-- Set cacheSeconds to -1 in Production Environment -->
	    <property name="cacheSeconds"><value>${ep.velocity.cache.seconds}</value></property>
	    <property name="defaultEncoding"><value>UTF-8</value></property>
	</bean>
	<!-- !!!! DOCvelocitySFxml -->

   	<bean id="storeResourceManager"	class="com.elasticpath.commons.util.impl.StoreResourceManagerImpl" factory-method="getInstance">
		<property name="storeConfig" ref="threadLocalStorage" />
	</bean>

	<bean id="storeConfigProxy" class="com.elasticpath.sfweb.util.impl.ThreadLocalStoreConfigProxyImpl" factory-method="getInstance">
		<property name="storeConfig" ref="threadLocalStorage" />
	</bean>

    <bean id="viewResolver" class="com.elasticpath.sfweb.view.velocity.StoreVelocityViewResolver">
		<property name="viewClass">
			<value>com.elasticpath.sfweb.view.velocity.StoreVelocityViewImpl</value>
		</property>
		<property name="contentType">
			<value>text/html;charset=UTF-8</value>
		</property>

		<property name="storeConfig" ref="threadLocalStorage"/>
		<property name="velocityConfigurer" ref="velocityConfigurer"/>

		<!-- Required to allow Velocity and Spring AbstractWizardFormController to integrate -->
		<property name="allowSessionOverride"><value>true</value></property>

		<property name="cache"><value>true</value></property>
        <property name="prefix"><value></value></property>
        <property name="suffix"><value>.vm</value></property>
        <property name="exposeSpringMacroHelpers"><value>true</value></property>
		<property name="exposeRequestAttributes"><value>true</value></property>
		<property name="exposeSessionAttributes"><value>true</value></property>
		<property name="dateToolAttribute"><value>dateTool</value></property>
		<property name="numberToolAttribute"><value>numberTool</value></property>
		<property name="toolboxConfigLocation"><value>/WEB-INF/misc/velocity/toolbox.xml</value></property>
		<property name="requestContextAttribute" value="requestContext"/>
    </bean>

	<bean id="velocityConfigurer" class="com.elasticpath.sfweb.view.velocity.StoreVelocityConfigurer">
		<property name="storeConfig" ref="threadLocalStorage"/>
        <property name="velocityPropertiesMap" ref="velocityPropertiesMap"/>
    </bean>

	<bean id="velocityPropertiesMap" class="java.util.HashMap">
    		<constructor-arg>
    			<map>
				<entry key="resource.loader" value="file" />
    	           <entry key="file.resource.loader.instance">
						<bean class="com.elasticpath.commons.util.impl.ContextAwareFileResourceLoader">
							<property name="assetRepository">
								<ref bean="assetRepository" />
							</property>
                    	</bean>
				   </entry>
    	           <entry key="webapp.resource.loader.instance">
						<bean class="com.elasticpath.commons.util.impl.ContextAwareWebappResourceLoader"/>
				   </entry>
    	           <entry key="file.resource.loader.cache"><value>true</value></entry>
    	           <entry key="velocimacro.library"><value>VM_global_library.vm, layout.vm, contentSpaceLibrary.vm, catalog/product/productMacros.vm, checkout/checkoutMacros.vm</value></entry>
            	   <!-- Set velocimacro.library.autoreload to false in Production Environment -->
    	           <entry key="velocimacro.library.autoreload"><value>${ep.velocity.library.autoreload}</value></entry>
           	       <entry key="velocimacro.permissions.allow.inline"><value>true</value></entry>
            	   <entry key="velocimacro.permissions.allow.inline.to.replace.global"><value>true</value></entry>
    	           <entry key="velocimacro.permissions.allow.inline.local.scope"><value>true</value></entry>
        	       <entry key="velocimacro.context.localscope"><value>false</value></entry>
    	           <!-- To turn off the message output from velocity macro -->
        	       <entry key="velocimacro.messages.on"><value>false</value></entry>
    	           <!-- To complete turn off all logging from velocity -->
    	           <entry key="runtime.log.logsystem.class"><value>org.apache.velocity.runtime.log.NullLogSystem</value></entry>
    	           <entry key="template.encoding"><value>UTF-8</value></entry>
    	           <entry key="input.encoding"><value>UTF-8</value></entry>
    	           <entry key="output.encoding"><value>UTF-8</value></entry>
    	           <entry key="resource.manager.class"><value>com.elasticpath.commons.util.impl.StoreResourceManagerProxyImpl</value></entry>
    	           <entry key="class.resource.loader.class"><value>org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader</value></entry>
    	           <entry key="file.resource.loader.modificationCheckInterval"><value>${ep.velocity.cache.seconds}</value></entry>
        	   </map>
       		</constructor-arg>
    </bean>

</beans>
